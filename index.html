<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="referrer" content="no-referrer">
    <title>我的丝滑主页</title>
    
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <style>
        /* --- 样式保持不变，已包含移动端适配 --- */
        :root {
            --bg-color: #f5e6e8;
            --overlay-bg: rgba(0, 0, 0, 0.9);
            --btn-bg: rgba(0, 0, 0, 0.6); 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body, html {
            margin: 0; padding: 0; width: 100%; 
            height: 100vh; height: 100dvh; 
            background-color: var(--bg-color);
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif;
            overflow: hidden; touch-action: none;
        }

        .main-stage {
            display: flex; width: 100%; height: 100%;
            padding: 8px; gap: 8px;
            padding-bottom: calc(60px + env(safe-area-inset-bottom)); 
        }

        .column-viewport {
            flex: 1; height: 100%;
            overflow: hidden; position: relative;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            cursor: grab;
        }
        .column-viewport:active { cursor: grabbing; }

        .scroll-track {
            display: flex; flex-direction: column; gap: 10px;
            padding: 8px 0; width: 100%;
            will-change: transform; 
            transform: translate3d(0, 50px, 0);
            opacity: 0; transition: opacity 0.6s ease-out;
        }
        .scroll-track.loaded { opacity: 1; transform: translate3d(0, 0, 0); }

        .scroll-track img {
            width: 100%; height: auto; display: block;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: transform 0.15s, filter 0.2s;
            cursor: pointer;
            background: rgba(0,0,0,0.05); 
            min-height: 150px; 
        }
        .scroll-track img:active { transform: scale(0.96); filter: brightness(0.9); }

        .glass-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: calc(50px + env(safe-area-inset-bottom));
            padding-bottom: env(safe-area-inset-bottom);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            display: flex; justify-content: center; align-items: center;
            z-index: 90; cursor: pointer;
        }
        .glass-footer:active { background: rgba(255, 255, 255, 0.2); }

        .hitokoto-text {
            color: #555; font-size: 13px; font-weight: 500;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            padding: 0 20px;
            opacity: 1; transition: opacity 0.2s ease;
        }
        .text-hidden { opacity: 0; }

        .music-control-box {
            position: fixed; top: 20px; right: 20px;
            width: 44px; height: 44px;
            background-color: var(--btn-bg);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            z-index: 150; cursor: pointer;
            transition: transform 0.2s;
        }
        .music-control-box:active { transform: scale(0.9); }

        .music-icon-svg {
            width: 20px; height: 20px; fill: #fff;
            animation: rotate-disk 4s linear infinite;
            animation-play-state: paused; 
        }
        .music-control-box.playing .music-icon-svg { animation-play-state: running; }
        @keyframes rotate-disk { 100% { transform: rotate(360deg); } }

        .welcome-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 200;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: opacity 0.4s ease;
        }
        .welcome-modal-overlay.active { opacity: 1; visibility: visible; }

        .welcome-content-box {
            width: 80%; max-width: 320px;
            padding: 30px 20px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            text-align: center; color: #333;
            transform: translateY(20px) scale(0.95);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .welcome-modal-overlay.active .welcome-content-box { transform: translateY(0) scale(1); }

        .welcome-title { font-size: 20px; font-weight: bold; margin-bottom: 15px; }
        .welcome-info { font-size: 14px; line-height: 1.8; color: #666; margin-bottom: 25px; }
        .highlight-num { color: #d66d75; font-weight: 800; font-family: monospace; font-size: 1.1em; }
        
        .welcome-close-btn {
            display: inline-block; padding: 12px 35px;
            background: #333; color: #fff; border-radius: 30px;
            font-size: 14px; font-weight: 600; cursor: pointer;
        }

        .lightbox-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--overlay-bg); z-index: 999;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
            backdrop-filter: blur(8px);
        }
        .lightbox-modal.active { opacity: 1; pointer-events: auto; }
        .lightbox-image-container {
            width: 100%; height: 100%; display: flex; justify-content: center; align-items: center;
            transform: scale(0.95); transition: transform 0.3s;
        }
        .lightbox-modal.active .lightbox-image-container { transform: scale(1); }
        .lightbox-image { max-width: 100%; max-height: 100%; object-fit: contain; }
    </style>
</head>
<body>

    <audio id="bgm-audio" src="./bgm.mp3" loop preload="auto"></audio>

    <div class="music-control-box" id="music-toggle">
        <svg class="music-icon-svg" viewBox="0 0 24 24">
            <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
        </svg>
    </div>

    <div class="main-stage" id="stage">
        <div class="column-viewport">
            <div class="scroll-track" id="track-left">
                </div>
        </div>
        <div class="column-viewport">
            <div class="scroll-track" id="track-right">
                </div>
        </div>
    </div>

    <div class="glass-footer" id="hitokoto-box">
        <span class="hitokoto-text" id="hitokoto-text">正在加载每日一言...</span>
    </div>

    <div class="welcome-modal-overlay" id="welcome-modal">
        <div class="welcome-content-box">
            <div class="welcome-title">Welcome ✨</div>
            <div class="welcome-info">
                第 <span class="highlight-num" id="busuanzi_value_site_uv">...</span> 位访客<br>
                总访问量 <span class="highlight-num" id="busuanzi_value_site_pv">...</span> 次
            </div>
            <div class="welcome-close-btn" id="welcome-close">开启旅程</div>
        </div>
    </div>

    <div class="lightbox-modal" id="lightbox">
        <div class="lightbox-image-container">
            <img src="" class="lightbox-image" id="lightbox-img">
        </div>
    </div>

    <script>
        // ================= 1. 图片生成逻辑 (重点修改部分) =================
        
        // 配置您的 GitHub 仓库信息
        const GH_USER = "3305932347";
        const GH_REPO = "my-website-01";
        // 注意：如果是 master 分支，请把 'main' 改为 'master'
        const GH_BRANCH = "main"; 
        const IMG_FOLDER = "photos";
        const IMG_COUNT = 120; // 图片总数 1-120

        // 自动生成图片链接数组
        const myImages = [];
        for (let i = 1; i <= IMG_COUNT; i++) {
            // padStart(3, '0') 负责把 1 变成 '001', 12 变成 '012'
            const num = String(i).padStart(3, '0');
            const url = `https://cdn.jsdelivr.net/gh/${GH_USER}/${GH_REPO}@${GH_BRANCH}/${IMG_FOLDER}/${num}.jpg`;
            myImages.push(url);
        }

        // 随机打乱数组（洗牌算法），保证每次刷新看到的顺序不同
        myImages.sort(() => Math.random() - 0.5);

        // 将图片分配到左右两个轨道
        function distributeImages() {
            const trackLeft = document.getElementById('track-left');
            const trackRight = document.getElementById('track-right');
            
            // 一半放左边，一半放右边
            const half = Math.ceil(myImages.length / 2);
            const leftImgs = myImages.slice(0, half);
            const rightImgs = myImages.slice(half);

            appendImagesToTrack(trackLeft, leftImgs);
            appendImagesToTrack(trackRight, rightImgs);
        }

        function appendImagesToTrack(track, imgUrls) {
            // 确保每个轨道至少有 6 张图以保证滚动效果，不够就循环
            let displayList = [...imgUrls];
            while (displayList.length < 6) {
                displayList = displayList.concat(imgUrls);
            }

            // 这里为了实现无缝滚动，JS 会克隆一份，所以初始只需要生成一次即可
            // (Scroller 类的 init 方法会负责克隆)
            
            displayList.forEach(url => {
                const img = document.createElement('img');
                img.src = url;
                img.loading = "lazy"; // 懒加载
                // 绑定点击放大
                img.addEventListener('click', e => {
                    e.stopPropagation();
                    showLightbox(url);
                });
                track.appendChild(img);
            });
        }


        // ================= 2. 核心滚动逻辑 =================
        class Scroller {
            constructor(id, speed) {
                this.el = document.getElementById(id);
                this.speed = speed;
                this.y = 0;
                this.h = 0;
                this.ready = false;
            }
            init() {
                // 自动克隆：确保图片足够填满屏幕高度，实现无缝滚动
                const rawImgs = Array.from(this.el.children);
                if(rawImgs.length === 0) return;

                // 克隆所有图片追加到后面，制造无缝效果
                rawImgs.forEach(img => {
                    // 注意：克隆的图片也需要绑定点击事件
                    const clone = img.cloneNode(true);
                    clone.addEventListener('click', e => {
                        e.stopPropagation();
                        showLightbox(clone.src);
                    });
                    this.el.appendChild(clone);
                });

                // 检测图片加载
                const allImgs = this.el.querySelectorAll('img');
                let c = 0;
                
                const check = () => {
                    c++;
                    // 当加载完成 80% 的时候就开始滚动，不等全部
                    if (c >= allImgs.length * 0.8) setupMetrics();
                }

                allImgs.forEach(img => {
                    if(img.complete) check();
                    else img.onload = check;
                    img.onerror = check; // 即使加载失败也继续计数
                });

                const setupMetrics = () => {
                    if(this.ready) return;
                    this.h = this.el.scrollHeight / 2; 
                    this.el.classList.add('loaded');
                    this.ready = true;
                }
            }
            move(dy) {
                if (!this.ready || this.h === 0) return;
                this.y += dy;
                if (this.y <= -this.h) this.y += this.h;
                else if (this.y > 0) this.y -= this.h;
                this.el.style.transform = `translate3d(0, ${this.y}px, 0)`;
            }
        }

        const left = new Scroller('track-left', 0.5);
        const right = new Scroller('track-right', 0.8);

        let dragging = false, lastY = 0, timer = null, paused = false;
        let isTabHidden = false;

        function loop() {
            requestAnimationFrame(loop);
            if (isTabHidden) return;
            
            const isModal = document.getElementById('welcome-modal').classList.contains('active') || 
                            document.getElementById('lightbox').classList.contains('active');
            
            if (isModal) return;

            if (!dragging && !paused) {
                left.move(-left.speed);
                right.move(-right.speed);
            }
        }

        // ================= 3. 交互与状态 =================
        const stage = document.getElementById('stage');
        
        stage.addEventListener('pointerdown', e => {
            if(e.target.closest('#hitokoto-box')) return;
            dragging = true; paused = true;
            clearTimeout(timer);
            lastY = e.clientY;
        });

        stage.addEventListener('pointermove', e => {
            if(!dragging) return;
            e.preventDefault();
            const dy = e.clientY - lastY;
            lastY = e.clientY;
            left.move(dy); right.move(dy);
        });

        function stopDrag() {
            dragging = false;
            clearTimeout(timer);
            timer = setTimeout(() => { paused = false; }, 800);
        }
        stage.addEventListener('pointerup', stopDrag);
        stage.addEventListener('pointercancel', stopDrag);

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                isTabHidden = true;
                if(playing) audio.pause();
            } else {
                isTabHidden = false;
                if(playing) audio.play();
                stopDrag();
            }
        });

        // ================= 4. 音乐与功能 =================
        const audio = document.getElementById('bgm-audio');
        const mBtn = document.getElementById('music-toggle');
        let playing = false;

        function toggleMusic() {
            if(playing) {
                audio.pause();
                playing = false;
                mBtn.classList.remove('playing');
            } else {
                audio.play().then(() => {
                    playing = true;
                    mBtn.classList.add('playing');
                }).catch(() => {
                    console.log("需用户交互");
                });
            }
        }
        mBtn.addEventListener('click', toggleMusic);

        // 一言
        const hText = document.getElementById('hitokoto-text');
        function fetchHitokoto() {
            hText.classList.add('text-hidden');
            fetch('https://v1.hitokoto.cn/?c=d&c=i&c=k&max_length=18')
                .then(r => r.json())
                .then(d => { hText.textContent = `${d.hitokoto} ${d.from_who ? '— '+d.from_who : ''}`; })
                .catch(() => { hText.textContent = "生活明朗，万物可爱。"; })
                .finally(() => { hText.classList.remove('text-hidden'); });
        }
        document.getElementById('hitokoto-box').addEventListener('click', fetchHitokoto);

        // Lightbox
        const lb = document.getElementById('lightbox');
        const lbImg = document.getElementById('lightbox-img');
        function showLightbox(src) {
            lbImg.src = src;
            lb.classList.add('active');
        }
        lb.addEventListener('click', () => {
            lb.classList.remove('active');
        });

        // ================= 5. 初始化流程 =================
        window.onload = () => {
            // 1. 先生成图片 HTML
            distributeImages();

            // 2. 初始化滚动条
            left.init(); 
            right.init(); 
            loop();
            
            // 3. 其它逻辑
            fetchHitokoto();
            setTimeout(() => { 
                document.getElementById('welcome-modal').classList.add('active'); 
            }, 300);

            // 不蒜子容错
            setTimeout(() => {
                const uv = document.getElementById('busuanzi_value_site_uv');
                if(uv && uv.textContent === '...') uv.textContent = '∞';
            }, 3000);
        };

        document.getElementById('welcome-close').addEventListener('click', () => {
            document.getElementById('welcome-modal').classList.remove('active');
            toggleMusic(); 
        });

    </script>
</body>
</html>
